<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kadai04 Chat(Firebase使用)</title>
    <link rel="stylesheet" href="./css/reset.css" />
    <link rel="stylesheet" href="./css/style.css" />

    <!-- Material Design Lite -->
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
    />

    <!-- Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="" />
    <link
      href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@300;400;500;700&amp;display=swap"
      rel="stylesheet"
    />
  </head>

  <body>
    <div class="layout">
      <!-- Header section containing logo -->
      <header class="layout_header">
        <div class="grid">
          <div class="layout_header-row">
            <h3>
              <i class="material-icons">chat_bubble_outline</i> チャットアプリ
            </h3>
          </div>
        </div>
      </header>

      <main>
        <!-- コンテンツ表示画面 -->
        <div class="balloonA">
          <div id="output" style="overflow: auto; height: 300px"></div>
        </div>

        <div>
          <div>
            <input
              type="text"
              id="uname"
              placeholder="名前を入力してください"
            />
          </div>
          <div>
            <textarea id="text" placeholder="文章を入力してください"></textarea>
          </div>
          <div>
            <input type="hidden" id="time" />
          </div>
          <button id="send">送信</button>
        </div>
      </main>
    </div>
    <footer></footer>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <!-- 必ず自分で作成した script.jsよりも上に貼り付ける -->
    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-app.js";
      import {
        getDatabase,
        ref,
        push,
        set,
        update,
        remove,
        onChildAdded,
        onChildChanged,
        onChildRemoved,
        onDisconnect,
        serverTimestamp,
      } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-database.js";

      // FirebaseのRealtime Database管理画面に表示された値をコピーして貼り付ける
      const firebaseConfig = {
        apiKey: "AIzaSyAK_59gTcgHB0jqS9YvMeHmbGuj56oD0YQ",
        authDomain: "dev28-34b97.firebaseapp.com",
        projectId: "dev28-34b97",
        storageBucket: "dev28-34b97.firebasestorage.app",
        messagingSenderId: "941478211478",
        appId: "1:941478211478:web:ebcace4368cfe6fc24f7b7",
      };
      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app); //RealtimeDBに接続
      const dbRef = ref(db, "chat"); //RealtimeDB内の"chat"に格納する

      //データ登録(Click)
      $("#send").on("click", function () {
        let timeOnClick = new Date();
        console.log(timeOnClick);
        const jsonTime = timeOnClick.toJSON();
        console.log(jsonTime);
        const uname = $("#uname").val();
        const text = $("#text").val();
        const time = timeOnClick;

        // オブジェクト変数にする
        const msg = {
          uname: $("#uname").val(),
          text: $("#text").val(),
          time: timeOnClick.toJSON(),
        };
        //ユニークKEY（ここではnewPostRef)を生成
        const newPostRef = push(dbRef);
        //"chat"にユニークKEYをつけてオブジェクトデータを登録
        set(newPostRef, msg);
      });

      //最初にデータ取得 ＆onSnapshotでリアルタイムにデータを取得
      onChildAdded(dbRef, function (data) {
        const msg = data.val(); //オブジェクトデータを取得し、変数msgに代入
        const key = data.key; //データのユニークキー（削除や更新に必須）
        //表示用テキスト・HTMLを作成
        let h = '<p id="' + key + '">';
        h += msg.uname;
        h += "<br>";
        // h += msg.text;
        h +=
          '<span contentEditable "true" id="' +
          key +
          '_update">' +
          msg.text +
          "</span>";
        h += '<span class="remove" data-key= "' + key + '">【削除】</span>';
        h += '<span class="update" data-key= "' + key + '">【更新】</span>';
        h += "<br>";
        h += msg.time;
        h += "</p>";
        $("#output").prepend(h); //#outputに追加
      });
      // 削除イベント
      $("#output").on("click", ".remove", function () {
        const key = $(this).attr("data-key");
        const remove_item = ref(db, "chat/" + key);
        remove(remove_item); //Firebaseデータ削除関数
      });

      // 更新イベント
      $("#output").on("click", ".update", function () {
        const key = $(this).attr("data-key");
        update(ref(db, "chat/" + key), {
          text: $("#" + key + "_update").html(), // テキスト文字を書き換えられるようにする
        });
      });

      // 削除処理がFirebase側で実行されたらイベント発生！
      onChildRemoved(dbRef, (data) => {
        $("#" + data.key).remove(); // DOM操作関数（対象を削除）
      });

      // 更新処理がFirebase側で実行されたらイベント発生！
      onChildChanged(dbRef, (data) => {
        $("#" + data.key + "_update").html(data.val().text);
        $("#" + data.key + "_update")
          .fadeOut(800)
          .fadeIn(800);
      });
    </script>
    <script src="./js/script.js"></script>
  </body>
</html>
